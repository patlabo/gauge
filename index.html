<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live PSI Gauge (Web Bluetooth)</title>
    <!-- Load Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
        }
        .gauge-display {
            /* Ensures text takes up most of the screen vertically */
            min-height: 40vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            line-height: 0.8; /* Tighten up line spacing for the large numbers */
        }
        .psi-unit {
            font-size: 2rem;
            color: #6b7280; /* Gray-500 */
            margin-top: -1.5rem; /* Pull unit closer to the number */
        }
        /* Mobile optimization: make the button area sticky for easy access */
        .controls {
            position: sticky;
            bottom: 0;
            padding: 1rem 0;
            background: linear-gradient(to top, #0d1117, transparent);
        }
    </style>
</head>
<body class="text-white">
    <div class="flex flex-col min-h-screen p-4">
        
        <header class="text-center py-6">
            <h1 class="text-2xl font-bold text-blue-400">ESP32 Live Pressure Gauge</h1>
            <p id="status" class="text-sm mt-1 text-yellow-500">
                Connection Status: Disconnected
            </p>
            <p class="text-xs mt-1 text-gray-400">
                Open in Chrome or Edge on iOS for Web Bluetooth support.
            </p>
        </header>

        <!-- Main Gauge Display -->
        <main class="flex-grow gauge-display">
            <div class="p-8 rounded-xl shadow-2xl bg-gray-800 bg-opacity-50">
                <span id="psiValue" class="text-9xl md:text-[12rem] font-extrabold tracking-tight text-white transition-all duration-300">
                    --.-
                </span>
                <div class="psi-unit text-center">PSI</div>
            </div>
        </main>

        <!-- Controls and Logs -->
        <div class="controls flex flex-col space-y-3">
            <!-- Bluetooth Connect Button -->
            <button id="connectButton" onclick="requestDeviceAndConnect()"
                    class="w-full py-4 text-xl font-semibold rounded-xl transition-all duration-200 shadow-lg 
                           bg-blue-600 hover:bg-blue-700 active:scale-95">
                Connect to ESP32 Gauge
            </button>
            
            <!-- Mock Data Button -->
            <button id="mockButton" onclick="toggleMockData()"
                    class="w-full py-3 text-lg font-medium rounded-xl transition-all duration-200 shadow-lg 
                           bg-gray-700 hover:bg-gray-600 active:scale-95">
                Start Mock Data
            </button>

            <!-- Debug Log -->
            <div class="mt-4 p-2 bg-gray-900 rounded-lg text-xs max-h-24 overflow-y-auto hidden" id="logContainer">
                <div class="font-bold text-gray-400 mb-1">Log:</div>
                <pre id="log" class="text-gray-500 whitespace-pre-wrap"></pre>
            </div>
        </div>
    </div>

    <script>
        // Constants matching the ESP32 setup (Nordic UART Service)
        const NUS_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const RX_CHAR_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; 

        let bleDevice = null;
        let rxCharacteristic = null;
        let mockDataInterval = null; // New variable for the mock data timer
        let isMockingData = false;
        let currentMockPsi = 50.0; // Starting PSI for mock data

        const psiValueElement = document.getElementById('psiValue');
        const statusElement = document.getElementById('status');
        const connectButton = document.getElementById('connectButton');
        const mockButton = document.getElementById('mockButton');

        /**
         * Utility to update the status text and optionally log messages.
         */
        function updateStatus(text, isError = false, isMock = false) {
            console.log(text);
            statusElement.textContent = `Connection Status: ${text}`;
            if (isMock) {
                statusElement.className = 'text-sm mt-1 text-purple-400';
            } else {
                statusElement.className = `text-sm mt-1 ${isError ? 'text-red-500' : 'text-yellow-500'}`;
            }
        }

        /**
         * Simulates receiving data from the ESP32.
         * Note: The real event handler expects an event, but we simulate the core logic.
         */
        function updateGaugeDisplay(dataString) {
            const psi = parseFloat(dataString.trim());
            
            if (!isNaN(psi)) {
                // Update the gauge display
                psiValueElement.textContent = psi.toFixed(1); // Show one decimal place
            }
        }
        
        /**
         * Handles incoming data from the ESP32 (real Bluetooth).
         */
        function handleCharacteristicValueChanged(event) {
            const value = event.target.value;
            // The ESP32 sends the PSI value as a simple string (e.g., "105.4")
            const decoder = new TextDecoder('utf-8');
            const dataString = decoder.decode(value);
            updateGaugeDisplay(dataString);
        }

        /**
         * Toggles the mock data generation on and off.
         */
        function toggleMockData() {
            if (isMockingData) {
                // STOP MOCKING
                clearInterval(mockDataInterval);
                isMockingData = false;
                mockButton.textContent = "Start Mock Data";
                mockButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                mockButton.classList.add('bg-gray-700', 'hover:bg-gray-600');
                updateGaugeDisplay('--.-');
                updateStatus("Mock Data Stopped. Ready to connect.");
                connectButton.disabled = false;
            } else {
                // START MOCKING
                if (bleDevice && bleDevice.gatt.connected) {
                    // Prevent mock data from running while real Bluetooth is active
                    updateStatus("Error: Disconnect real device before running mock data.", true);
                    return;
                }
                isMockingData = true;
                mockButton.textContent = "Stop Mock Data (Live)";
                mockButton.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                mockButton.classList.add('bg-red-600', 'hover:bg-red-700');
                connectButton.disabled = true;
                updateStatus("Mock Data Running (Simulating PSI)", false, true);

                // Start the simulation timer
                mockDataInterval = setInterval(() => {
                    // Randomly adjust the PSI value to simulate fluctuation
                    const delta = (Math.random() * 2) - 1; // Change between -1.0 and +1.0
                    currentMockPsi = Math.max(0, Math.min(150, currentMockPsi + delta)); // Cap between 0 and 150 PSI
                    
                    updateGaugeDisplay(currentMockPsi.toFixed(1));
                }, 500); // Update every 100ms
            }
        }
        
        /**
         * Starts the Web Bluetooth connection process.
         */
        async function requestDeviceAndConnect() {
            if (isMockingData) {
                updateStatus("Mock data is running. Please stop it before connecting to Bluetooth.", true);
                return;
            }

            if (!navigator.bluetooth) {
                updateStatus("Error: Web Bluetooth not supported in this browser.", true);
                console.error("Web Bluetooth is not supported in this browser. Please use Google Chrome or Microsoft Edge on iOS.");
                return;
            }

            try {
                updateStatus("Requesting device access...");
                connectButton.disabled = true;
                connectButton.textContent = "Scanning...";
                mockButton.disabled = true; // Disable mock while scanning
                
                // Request the device, filtering by the Nordic UART Service UUID
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [NUS_SERVICE_UUID] }],
                });
                
                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
                
                updateStatus(`Found device: ${bleDevice.name}. Connecting...`);
                await connectGATT();

            } catch (error) {
                updateStatus(`Connection Error: ${error.message}`, true);
                connectButton.disabled = false;
                connectButton.textContent = "Connect to ESP32 Gauge";
                mockButton.disabled = false;
            }
        }

        /**
         * Connects to the GATT server, discovers services and characteristics.
         */
        async function connectGATT() {
            try {
                const server = await bleDevice.gatt.connect();
                updateStatus("Connected to GATT server. Discovering services...");
                
                const service = await server.getPrimaryService(NUS_SERVICE_UUID);
                updateStatus("Discovered NUS service. Discovering characteristics...");

                rxCharacteristic = await service.getCharacteristic(RX_CHAR_UUID);
                updateStatus("Discovered RX characteristic. Subscribing to notifications...");

                await rxCharacteristic.startNotifications();
                rxCharacteristic.addEventListener('characteristicvaluechanged', handleCharacteristicValueChanged);

                updateStatus("Subscribed to data stream (LIVE)", false);
                statusElement.className = 'text-sm mt-1 text-green-500';
                
                // Change the button text/functionality
                connectButton.textContent = "Connected (Live)";
                connectButton.disabled = true;
                mockButton.disabled = true; // Disable mock while connected

            } catch (error) {
                updateStatus(`GATT Error: ${error.message}. Check ESP32 NOTIFY property.`, true);
                connectButton.disabled = false;
                connectButton.textContent = "Connect to ESP32 Gauge";
                mockButton.disabled = false; // Re-enable mock
                if (bleDevice && bleDevice.gatt.connected) {
                    bleDevice.gatt.disconnect();
                }
            }
        }

        /**
         * Handles device disconnection.
         */
        function onDisconnected() {
            updateStatus(`Device disconnected. Attempting to reconnect...`, true);
            psiValueElement.textContent = '--.-';
            connectButton.disabled = false;
            connectButton.textContent = "Connect to ESP32 Gauge";
            mockButton.disabled = false; // Re-enable mock

            // Small delay before attempting to reconnect
            setTimeout(async () => {
                 if (bleDevice) {
                    try {
                        updateStatus("Reconnecting...");
                        await connectGATT();
                    } catch (error) {
                        updateStatus(`Reconnection failed: ${error.message}`, true);
                        connectButton.disabled = false;
                        connectButton.textContent = "Connect to ESP32 Gauge";
                        mockButton.disabled = false;
                    }
                }
            }, 2000); // Wait 2 seconds before trying to reconnect
        }

        // Initialize display to show the disconnected state
        psiValueElement.textContent = '--.-';
        updateStatus("Ready to connect. Tap the button or start mock data.");

    </script>
</body>
</html>
